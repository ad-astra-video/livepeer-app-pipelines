<%- include('partials/header', { title: 'Dashboard', currentUser, activePage: 'dashboard' }) %>
<%- include('partials/flash', { flash }) %>
<% if (!canManage) { %>
  <div class="notice">
    <p><strong>Read-only mode:</strong> You can browse pool entries and API keys, but only admins or read-write users can make changes.</p>
  </div>
<% } %>
<%- include('partials/settings-modal', { settings, canManage }) %>
<div class="card">
  <h2>Pool entries</h2>
  <form method="post" action="/admin/pool">
    <label for="address">Orchestrator URL</label>
    <input id="address" name="address" type="url" placeholder="https://example.com" <%= canManage ? '' : 'disabled' %> required />
    <button class="btn" type="submit" <%= canManage ? '' : 'disabled' %>>Add to pool</button>
  </form>
  <% if (poolEntries.length === 0) { %>
    <p>No entries yet. Add the first orchestrator URL above.</p>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Address</th>
          <th>Score</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% poolEntries.forEach(function(entry) { %>
          <tr>
            <td><%= entry.address %></td>
            <td><%= entry.score %></td>
            <td><%= entry.is_active ? 'Active' : 'Disabled' %></td>
            <td>
              <form class="inline" method="post" action="/admin/pool/<%= entry.id %>/<%= entry.is_active ? 'disable' : 'enable' %>">
                <button class="btn btn-outline btn-small" type="submit" <%= canManage ? '' : 'disabled' %>><%= entry.is_active ? 'Disable' : 'Enable' %></button>
              </form>
              <form class="inline" method="post" action="/admin/pool/<%= entry.id %>/delete" onsubmit="return confirm('Remove this pool entry?');">
                <button class="btn btn-danger btn-small" type="submit" <%= canManage ? '' : 'disabled' %>>Remove</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<div class="card">
  <h2>Access keys</h2>
  <form method="post" action="/admin/keys">
    <label for="label">Label</label>
    <input id="label" name="label" type="text" placeholder="optional label" <%= canManage ? '' : 'disabled' %> />
    <label for="apiKey">Key value</label>
    <input id="apiKey" name="apiKey" type="text" placeholder="sk_test_123" <%= canManage ? '' : 'disabled' %> required />
    <button class="btn" type="submit" <%= canManage ? '' : 'disabled' %>>Save key</button>
  </form>
  <% if (apiKeys.length === 0) { %>
    <p>No keys stored yet. Create one above.</p>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Label</th>
          <th>Key</th>
          <th>Status</th>
          <th>Added</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% apiKeys.forEach(function(key) { %>
          <tr>
            <td><%= key.label || '—' %></td>
            <td><code><%= key.api_key %></code></td>
            <td><%= key.is_active ? 'Active' : 'Disabled' %></td>
            <td><%= new Date(key.created_at).toLocaleString() %></td>
            <td>
              <form class="inline" method="post" action="/admin/keys/<%= key.id %>/<%= key.is_active ? 'disable' : 'enable' %>">
                <button class="btn btn-outline btn-small" type="submit" <%= canManage ? '' : 'disabled' %>><%= key.is_active ? 'Disable' : 'Enable' %></button>
              </form>
              <form class="inline" method="post" action="/admin/keys/<%= key.id %>/delete" onsubmit="return confirm('Remove this API key? This action cannot be undone.');">
                <button class="btn btn-danger btn-small" type="submit" <%= canManage ? '' : 'disabled' %>>Remove</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
  <p>
    Clients can validate a key by sending
    <code>POST /admin/auth</code> with body <code>{"stream":"YOUR_KEY"}</code>.
  </p>
</div>

<div class="card">
  <h2>API references</h2>
  <p>
    <strong>Pool list</strong>: <code>GET /admin/pool</code> → JSON array like
    <code>[{"address":"url","score":"0"}]</code>
  </p>
  <p>
    <strong>Key validation</strong>: <code>POST /admin/auth</code> with JSON
    <code>{"stream":"API_KEY"}</code> → <code>{"valid":true,"stream_id":"XXXXXXXXXX"}</code>
  </p>
</div>
<%- include('partials/footer') %>
